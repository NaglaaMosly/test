pipeline {

	agent any
	
	environment {
	 	PROJECT_VERSION = "${sh(script:"sed -n '3p' package.json | cut -f 2 -d':'| cut -b 3-7 ", returnStdout: true).trim()}"
		}
		
	stages {
		  
		stage('Load env variables') {
			steps {
				sh 'printenv';
				
			script {
					load("./${GIT_LOCAL_BRANCH}-properties")
				  }
				sh "echo imageTag: ${imageTag}"
				sh "echo imageName: ${imageName}"
				sh "echo containerName: ${containerName}"
				sh "echo app_profile: ${app_profile}"
					
				sh ("sed -i.bak 's#app_profile#${app_profile}#g'  resources/Dockerfile-win")
		    }
		}

		stage('Build stage') {
        	steps {
				sh "docker stop ${containerName} || true && docker rm ${containerName} || true && docker rmi ${imageName}:${imageTag} || true "
				sh "rm -rf ./be-login  ./be-login*.gz "	
				sh "docker build -f resources/Dockerfile-win  -t ${imageName}:${imageTag} ."
                sh "docker run -d --name ${containerName}  ${imageName}:${imageTag}"
            }  
		}	    	
			
		stage('Transition stage') {
			steps {
				//copy files from the container to the job
				sh "docker cp ${containerName}:/opt/app/dist  ./be-login"
			}
		}
		
		stage('Archive') {
            steps {
				sh "cp resources/.htaccess   ./be-login"
            	sh 'tar -cvzf  be-login.tar.gz  --strip-components=1  be-login/*'
                archiveArtifacts artifacts: 'be-login.tar.gz'
           }
		}
			
		stage('Deploy on windows server') {
		  	steps{
			  
			//confirmation
			 /*script {
                	timeout(time: 2, unit: 'MINUTES') {
                    input(id: "Deploy Gate", message: "Deploy ${params.project_name}?", ok: 'Deploy') }
           		}*/

				sh "cp -r be-login.tar.gz    be-login@${PROJECT_VERSION}.tar.gz "
					   
				sshPublisher(publishers: [sshPublisherDesc(configName: 'windows-deploy', \
				transfers: [sshTransfer( sourceFiles: 'be-login/**')])])
					 
				sshPublisher(publishers: [sshPublisherDesc(configName: 'windows-deploy', \
				transfers: [sshTransfer( remoteDirectory: 'archive-ui/be-login/', \
						                 sourceFiles: 'be-login@*.gz/**')])])
				
				sh 'echo "you can access tha app from http://10.95.0.178/be-login/ " '
			}
		}
	}
}
